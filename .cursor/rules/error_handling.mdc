---
description: Python エラーハンドリングガイドライン
globs:
  - "**/*.py"
alwaysApply: true
---

## 基本原則
- **Fail fast, fail loudly**: 想定外のエラーは即座に表面化しスタックトレースを保持する。
- **回復可能なエラーのみ捕捉する**。回復できない場合は文脈を保持したまま再送出する。
- **ハッピーパスをクリーンに保つ**。エラーロジックは隔離し、テストしやすくする。

---
## 使い分け早見表（詳細版）
| パターン | 適切な状況 | 長所 | 注意点 / 罠 | 典型的なコード |
| --- | --- | --- | --- | --- |
| **EAFP (`try ... except`)** | 失敗は“まれ”でレースコンディションがあり得る | ネストが浅い／競合に強い | 多用するとパフォーマンス低下・except が膨張 | `try: open(p)\nexcept FileNotFoundError: ...` |
| **LBYL** | 高頻度で失敗が起こり事前チェックが安価 | 例外オーバーヘッド回避 | TOCTOU (チェック→実行間の競合) に弱い | `if path.exists(): ...` |
| **`with` コンテキストマネージャ** | 資源確保↔解放を確実に行いたい | `finally` を隠蔽し漏れを防ぐ | カスタム CM の実装コスト | `with open(fname) as f:` |
| **`contextlib.suppress()`** | 既知・無害な失敗を安全に無視 | 1 行で意図を明示 | 誤用するとバグを飲み込む | `with suppress(KeyError): d.pop(k)` |
| **`ExitStack`** | コンテキスト数が動的 | 可読性維持、複数 CM を一括管理 | 多用すると読者に学習コスト | `with ExitStack() as s: ...` |
| **`ExceptionGroup` / `except*` (3.11+)** | asyncio / 並列で複数例外 | まとめて分類処理できる | Python 3.11 以上限定 | `except* ValueError as eg:` |
| **Result パターン** | バリデーション・業務エラーを値で返す | 明示的フロー制御・型ヒント活用 | 呼び出し側が煩雑 | `return Result.Fail(msg)` |
| **再試行デコレータ (`@retry`)** | 一時的失敗を自動再試行 | 冗長コードを削除 | 閾値・間隔設計が必要 | `@retry(times=3)` |

---
## 判断フローチャート（テキスト版）
1. **その失敗はビジネスロジックの一部か？**
   - **Yes** → Result パターン／`Optional`／バリデーション例外を定義
   - **No** → 2 へ
2. **失敗頻度は高いか？**
   - **高い** → LBYL or デフォルト値取得 (`dict.get` 等)
   - **低い** → 3 へ
3. **回復可能か？**
   - **Yes** → 狭い `try ... except` で処理／再試行デコレータ
   - **No** → 4 へ
4. **リソース解放が必要か？**
   - **Yes** → `with` または CM
   - **No** → `raise` で伝搬し呼び出し側でハンドリング

---
## 例外ログ運用
- **捕捉時に最低 1 回ログ**: `logging.exception()` を使用。
- **二重ログ禁止**: 階層のどこで記録するか整理。
- **構造化ログ推奨**: JSON formatter で解析容易に。

---
## アンチパターンまとめ
- 大きなブロックを一括 `try`。
- `except Exception:` によるバグ隠し。
- 何もせず `pass`。
- パフォーマンスクリティカルなループで例外をフロー制御に使用。

---
## バージョン互換性
- 3.11+ : `ExceptionGroup`, `except*` 利用可。
- 旧バージョンでは個別処理かサードパーティ実装を検討。

---
## 参考文献
- PEP 8 (Error Handling)
- PEP 654 (Exception Groups)
- `contextlib` ドキュメント
- Google Python Style Guide (Errors and Exceptions)

