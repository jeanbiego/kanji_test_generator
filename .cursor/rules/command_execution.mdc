# コマンド実行の安定化ルール

## 概要
Cursor におけるコマンド実行がハング・終了検知不能に陥る問題を避けるため、ラッパースクリプトと完了マーカーを用いて、確実に「実行完了」を検出できるようにするためのルールです。

## 中核原則

### 1. 長時間・大量出力コマンドはラッパー経由で実行
- 長時間動作または出力が多いコマンドは必ずラッパースクリプト経由で実行する
- ラッパーは stderr を stdout にリダイレクトし、最後に完了マーカーを出力する
- これにより Cursor は終了を確実に検出できる

### 2. 完了マーカーの統一
- 標準の完了マーカーは `[[DONE]]`
- すべてのラッパースクリプトは最後にこのマーカーを出力すること
- Cursor はこのマーカーを用いて次のアクションに進む

### 3. 非対話モードを優先
- 可能な場合は常に非対話オプションを付与する:
  - `--non-interactive`
  - `--yes` / `-y`
  - `--no-input`
- 対話が避けられない場合は、明確な終了手順を提示する

### 4. 早期失敗の検出
- テストには `--maxfail=1` 等を使い、失敗を早めに表面化
- 出力は `--max-workers` や `--max-threads`、`tail -n 200` などで制限
- 過剰出力による Cursor 側の混乱を防止

## 実装ガイドライン

### コマンド実行パターン
```bash
# 汎用コマンド
./cursor-run <command>

# pytest 実行
./pytest-cursor -k "pattern" -m "slow or smoke"

# ビルド系
./cursor-run make build
./cursor-run npm run build

# ログ閲覧（出力制限）
./cursor-run your_cmd | tail -n 200
```

### ラッパースクリプトの要件
- stderr を stdout にまとめる: `2>&1`
- 終了時に `[[DONE]]` マーカーを出力
- 元の終了コードを保持して終了
- 代表的な失敗シナリオを考慮して扱う

### 典型的なハング要因と対策
- **stderr のみ出力**: ラッパーで `2>&1` を使用
- **無限ログ**: `--maxfail=1`、`--max-workers`、`tail -n 200` を付与
- **対話プロンプト**: `--yes`、`-y`、`--non-interactive` を追加
- **終了コードが必要**: ラッパーで元の終了コードを保持

## PowerShell 特有の注意点

### コマンド連結
- コマンド連結には `&&` ではなく `;` を使用する
- 例: `git status; git add .; git commit -m "message"`

### 出力制限
- `tail -n 200` の代わりに `| Select-Object -First 200` を使用
- 長い出力には `| Out-String -Width 4096` を併用

### バックグラウンド実行
- 真にバックグラウンドで動かす場合は `Start-Job`
- 同一ウィンドウで維持が必要な場合は `-NoNewWindow`

### Pager 無効化（重要）
大量出力コマンド（特に Git）は既定で pager（`less` 等）を使用し、Cursor が終了を検知できない原因になります。以下のいずれかで pager を無効化してください。

- 一時的（コマンド単位）:
  - Git: `git --no-pager <subcommand>`
  - Git（設定一時上書き）: `git -c core.pager=cat <subcommand>`
- セッション単位（PowerShell）:
  - `\$env:GIT_PAGER = 'cat'`（pager を事実上無効化）
  - もしくは `\$env:LESS = '-F -X'`（必要時のみ表示・終了時クリア抑止）
- 永続設定（リポジトリ/ユーザー）:
  - `git config --local core.pager cat`（または `--global`）

推奨の具体例（PowerShell）:
```powershell
# 直近のみ 10 件を pager 無効で表示
git --no-pager log --oneline -10 | Select-Object -First 200

# diff を pager 無効で表示
git --no-pager diff --stat | Out-String -Width 4096

# 一時的にセッション全体で無効
$env:GIT_PAGER = 'cat'; git log --oneline -20
```

注意:
- `more`/`less` 等の pager が介在すると完了マーカー検知が乱れる
- CI/非対話環境では常に `--no-pager` または `GIT_PAGER=cat` を推奨

## VS Code / Cursor 連携

### Tasks 設定
- よく使うコマンドは `.vscode/tasks.json` に定義
- `Cmd/Ctrl+Shift+B` で pytest などを起動
- タスクの出力にも完了マーカーを含める

### カスタマイズ
- 完了マーカー環境変数: `CURSOR_DONE_MARKER`
- 既定: `[[DONE]]`
- `<<<END>>>` 等に変更することも可能

## エラーハンドリング

### コマンドが固まったとき
1. 完了マーカーの出力有無を確認
2. stderr のリダイレクトが正しいか確認
3. 出力制限の導入を検討
4. 非対話オプションの付与を検討

### リカバリアクション
- `Ctrl+C` で中断
- 適切なラッパースクリプトで再実行
- 非対話フラグの不足を確認
- コマンド構文・パラメータを再確認

## ベストプラクティス

### 実行前
1. 大量出力の可能性を検討
2. 非対話オプションの有無を確認
3. 対話プロンプト発生の有無を想定
4. 複雑なコマンドはラッパー経由にする

### 実行中
1. 完了マーカーの出力を監視
2. stderr のみ出力に注意
3. 固まったら中断できる準備
4. 長時間処理は出力制限を併用

### 実行後
1. 完了マーカーが受信されたか確認
2. 終了コードを確認（成功/失敗）
3. エラー/警告を出力から確認
4. 確認後に次のアクションへ進む

## 既存ルールとの統合

### Git 操作
- 大量出力があり得る Git コマンドはラッパー経由
- `status` / `log` / `diff` などは出力制限と `--no-pager` を併用
- 終了コードを保持して正しいエラーハンドリングを行う

### テスト
- pytest ラッパーに適切なフラグを付与
- 早期失敗検出を実装
- テスト結果を確実に取得

### ロギング
- 既存のロギングルールと統合
- 完了検出を阻害しないログ設計
- ノイズ低減のため構造化ログを推奨

このルールはワークスペースの既存ルールと併用し、Cursor における安定で信頼性の高いコマンド実行を実現します。
description:
globs:
alwaysApply: true
---
