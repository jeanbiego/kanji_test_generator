# 統合実装ワークフロー ルール

## 基本方針

このルールは、Suruga_2Dプロジェクトの実装作業における包括的なワークフローを定義します。実装手順、タグ履歴整備、テストコード事前作成、ドキュメント管理を統合的に管理し、品質と保守性を確保します。

---

## 1. 実装前準備フェーズ

### 1.1 要件分析と影響度評価
- **影響度の定義**:
  - **高**: アプリケーション全体の構造、主要機能、複数モジュールに影響
  - **中**: 特定の機能やモジュールに影響、他の部分への波及効果あり
  - **低**: 限定的な範囲（設定、UI、特定ファイル）のみに影響

- **優先度の決定**: 影響度の低いものから順次実装
- **実装順序**: 低 → 中 → 高の順序で進める

### 1.2 重複実装の防止
実装前に以下の確認を必須とする：
- 既存の類似機能の有無
- 同名または類似名の関数やコンポーネント
- 重複するAPIエンドポイント
- 共通化可能な処理の特定
- ディレクトリ構成の確認（`docs/directorystructure.md`を参照）

### 1.3 実装ファイルの作成
- **配置場所**: `docs/`直下
- **命名規則**: `{YYYYMMDD}_implementation_{タスク名}.md`
- **必須項目**:
  - タスク名と概要
  - 担当者
  - 開始日・予定完了日
  - 優先度（高・中・低）
  - 影響度（高・中・低）
  - 要件定義
  - 設計方針
  - 実装方法
  - テスト計画
  - 注意事項

---

## 2. 実装実行フェーズ

### 2.1 テストコードの事前作成（必須）
**実装前にテストコードを作成し、テスト駆動開発を実践する**

#### 2.1.1 テストファイルの配置
- **単体テスト**: `tests/test_{モジュール名}.py`
- **統合テスト**: `tests/integration/test_{機能名}.py`
- **テストデータ**: `tests/fixtures/`または`tests/data/`

#### 2.1.2 テストコードの基本構造
```python
import pytest
from unittest.mock import Mock, patch
from src.{モジュール名} import {クラス名}

class Test{クラス名}:
    def setup_method(self):
        """各テストメソッド実行前の準備"""
        pass
    
    def test_{テスト対象メソッド名}_正常系(self):
        """正常系のテスト"""
        # Arrange
        # Act
        # Assert
        pass
    
    def test_{テスト対象メソッド名}_異常系(self):
        """異常系のテスト"""
        # Arrange
        # Act
        # Assert
        pass
```

#### 2.1.3 テストの優先順位
1. **正常系テスト**: 基本的な動作確認
2. **境界値テスト**: エッジケースの確認
3. **異常系テスト**: エラーハンドリングの確認
4. **統合テスト**: 複数モジュール間の連携確認

### 2.2 実装の実行
- **段階的実装**: 小さな単位で実装し、各段階でテスト実行
- **動作確認**: 各段階完了後に動作確認を実施
- **ログ出力**: 適切なログレベルで実装過程を記録

### 2.3 コード品質の確保
- **Ruff/Black**: コードフォーマットとリントの実行
- **型ヒント**: 適切な型ヒントの追加
- **ドキュメント**: docstringの記述
- **エラーハンドリング**: 適切な例外処理の実装

---

## 3. テスト実行フェーズ

### 3.1 テストの実行順序
1. **単体テスト**: 個別モジュールの動作確認
2. **統合テスト**: モジュール間の連携確認
3. **システムテスト**: 全体の動作確認

### 3.2 テスト結果の評価
- **カバレッジ**: 80%以上のカバレッジを目標
- **失敗テスト**: 失敗したテストは即座に修正
- **パフォーマンス**: 必要に応じてパフォーマンステストを実行

### 3.3 テストデータの管理
- **テストデータ**: 本番データと分離して管理
- **モックデータ**: 外部依存を適切にモック化
- **フィクスチャ**: 再利用可能なテストデータの作成

---

## 4. ドキュメント更新フェーズ

### 4.1 実装ファイルの更新
実装完了後、以下の更新を必須とする：

#### 4.1.1 進捗管理の更新
- 完了した作業にチェックマーク（[x]）を付与
- 進行中の作業を「なし」に更新
- 未着手の作業を「なし」に更新

#### 4.1.2 実装完了サマリーの追加
- 完了した実装内容の詳細記録
- 動作確認結果の記録
- 今後の運用方針の記録

#### 4.1.3 状態の更新
- ファイル末尾の状態を「実装完了、テスト完了」に更新
- 最終更新日を実装完了日に更新

### 4.2 既存実装履歴への統合
- **統合先**: `docs/implementation/`内の適切な履歴ドキュメント
- **統合方法**: 既存ドキュメントに改善内容を追記
- **統合タイミング**: 実装完了・テスト完了・動作確認完了後

### 4.3 実装ノートの更新
- **課題の状態更新**: 該当課題の状態を「完了」に変更
- **完了日の記録**: 完了日を記録
- **次回予定の更新**: 影響度順での実装計画を更新

---

## 5. タグ履歴整備フェーズ

### 5.1 タグの作成
実装完了後、適切なタグを作成する：

#### 5.1.1 タグ命名規則
- **形式**: `v{メジャー}.{マイナー}.{パッチ}-{状態}-{機能名}`
- **例**: `v1.3.0-stable-documentation-rules`

#### 5.1.2 タグ作成のタイミング
- 実装完了時
- 重要なマイルストーン達成時
- リリース準備完了時

### 5.2 タグ履歴の更新
`docs/tag_history.md`に以下を記録：

#### 5.2.1 基本情報
- タグ名と作成日
- コミットハッシュ
- 内容の概要
- 現在の状態
- 主要な変更点

#### 5.2.2 実装メモとの紐づけ
- 対応する実装メモファイルへのリンク
- 実装内容の概要
- 完了状態の記録

### 5.3 実装メモとの整合性確保
- **ファイル名変更禁止**: 実装完了後も元のファイル名を維持
- **理由**: tag_history.mdとの整合性保持、実装履歴の追跡性確保
- **リンク形式**: `[ファイル名](docs/ファイル名)`

---

## 6. 品質管理フェーズ

### 6.1 最終動作確認
- **基本機能**: 既存機能の動作確認
- **新規機能**: 新規実装機能の動作確認
- **統合動作**: 全体システムの動作確認

### 6.2 ドキュメント整合性の確認
- 実装ファイルと実装ノートの整合性
- タグ履歴と実装メモの整合性
- リンクの有効性確認

### 6.3 リスク評価
- **高リスク項目**: アプリケーション全体に影響する変更
- **中リスク項目**: 特定機能に影響する変更
- **低リスク項目**: 限定的な範囲の変更

---

## 7. 運用フロー

### 7.1 完全な実装フロー
```
1. 要件分析と影響度評価
   ↓
2. 重複実装の防止確認
   ↓
3. 実装ファイルの作成
   ↓
4. テストコードの事前作成
   ↓
5. 段階的実装の実行
   ↓
6. 各段階でのテスト実行
   ↓
7. 実装完了・テスト完了
   ↓
8. ドキュメント更新
   ↓
9. 既存実装履歴への統合
   ↓
10. 実装ノートの更新
    ↓
11. タグの作成
    ↓
12. タグ履歴の更新
    ↓
13. 最終品質確認
    ↓
14. 完了
```

### 7.2 チェックリスト
実装完了時に以下を確認：

#### 7.2.1 実装品質
- [ ] テストコードが事前に作成されている
- [ ] 単体テストが全て通る
- [ ] 統合テストが全て通る
- [ ] コードフォーマットが適用されている
- [ ] 型ヒントが適切に記述されている

#### 7.2.2 ドキュメント品質
- [ ] 実装ファイルが更新されている
- [ ] 実装完了サマリーが記録されている
- [ ] 既存実装履歴に統合されている
- [ ] 実装ノートが更新されている

#### 7.2.3 タグ履歴品質
- [ ] 適切なタグが作成されている
- [ ] タグ履歴が更新されている
- [ ] 実装メモとの紐づけが完了している
- [ ] リンクの整合性が保たれている

---

## 8. 重要な注意事項

### 8.1 編集禁止ファイル
以下のファイルは編集を禁止：
- `src/connect_controller.py`: コントローラー接続の基本機能
- `src/suruga_import.py`: DLLファイルの読み込みと環境設定

### 8.2 技術スタックの制約
- 記載されたバージョンの変更は禁止
- 変更が必要な場合は事前承認を必須とする

### 8.3 UI/UX変更の制約
- レイアウト、色、フォント、間隔の変更は禁止
- 変更が必要な場合は事前承認を必須とする

---

## 9. 例外処理

### 9.1 実装中の問題発生時
- 即座に実装を停止
- 問題の詳細を分析
- 対策案を提案
- 承認を得てから再開

### 9.2 テスト失敗時の対応
- 失敗原因を特定
- 修正案を実装
- 再テストを実行
- 必要に応じてロールバック

### 9.3 ドキュメント整合性崩壊時
- 整合性が崩れた箇所を特定
- 修正案を提案
- 承認を得てから修正
- 再確認を実施

---

## 10. 継続的改善

### 10.1 ルールの見直し
- 実装完了後にルールの有効性を評価
- 改善点があればルールを更新
- チーム内で共有・確認

### 10.2 ベストプラクティスの蓄積
- 成功した実装パターンを記録
- 失敗した実装パターンを分析
- 教訓をドキュメント化

### 10.3 自動化の検討
- テスト実行の自動化
- ドキュメント更新の自動化
- 品質チェックの自動化

---

**最終更新日**: 2025-09-01
**バージョン**: 1.0
**状態**: 初版作成完了
description:
globs:
alwaysApply: true
---
