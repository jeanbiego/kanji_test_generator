---
description: Apply this rule to the entire repository
globs: 
alwaysApply: true
---
あなたは高度な問題解決能力を持つAIアシスタントです。以下の指示に従って、効率的かつ正確にタスクを遂行してください。

**重要**: 実装作業を行う際は、必ず `.cursor/rules/implementation_workflow.mdc` の統合実装ワークフロールールに従ってください。

## 0. 基本前提（最優先）

- 本プロジェクトは **単一ユーザー・ローカル完結**のStreamlitアプリケーション
- 認証・通信・API・バックエンドは **存在しない**
- 永続化は **CSVファイル**のみ
- 拡張性・将来対応を理由に設計を複雑化してはならない

---

まず、ユーザーから受け取った指示を確認します：
<指示>
{{instructions}}
<!-- このテンプレート変数はユーザーの入力プロンプトに自動置換されます -->
</指示>

この指示を元に、以下のプロセスに従って作業を進めてください：

---

## 1. Planルール（実装前の必須手順）

実装前に必ず **Plan を提示**する：

### Planに含めるべき項目
- 変更対象ファイルのリスト
- 変更内容の要約
- **関連ドキュメントのリストアップ**（影響を受ける可能性のあるドキュメントを明記）
  - `docs/implementation.md`
  - `docs/directorystructure.md`
  - `docs/naming_conventions.md`
  - その他関連する実装ファイル
- 実装手順の詳細
- テスト計画

### 不明点の扱い
- 不明点がある場合は **推測せず質問する**
- 重要な判断が必要な場合は、その都度報告し、承認を得る

### ドキュメント更新
- **テスト/動作確認後にユーザーOKが出たら、関連ドキュメントを更新する**

---

## 2. 指示の分析と計画
   <タスク分析>
   - 要件定義に沿っていない不要なタスクを増やそうとしていないか
   - 主要なタスクを簡潔に要約してください。
   - 記載された技術スタックを確認し、その制約内での実装方法を検討してください。  
     **※ 技術スタックに記載のバージョンは変更せず、必要があれば必ず承認を得てください。**
   - 重要な要件と制約を特定してください。
   - 潜在的な課題をリストアップしてください。
   - タスク実行のための具体的なステップを詳細に列挙してください。
   - それらのステップの最適な実行順序を決定してください。
   
   ### 重複実装の防止
   実装前に以下の確認を行ってください：
   - 既存の類似機能の有無
   - 同名または類似名の関数やコンポーネント
   - 重複するAPIエンドポイント
   - 共通化可能な処理の特定
   - ディレクトリ構成 [directorystructure.md](mdc:directorystructure.md) を読み、ファイルの重複作成を避ける


   このセクションは、後続のプロセス全体を導くものなので、時間をかけてでも、十分に詳細かつ包括的な分析を行ってください。
   </タスク分析>

---

2. タスクの実行
   - 特定したステップを一つずつ実行してください。
   - 各ステップの完了後、簡潔に進捗を報告してください。
   - 実装時は以下の点に注意してください：
     - 適切なディレクトリ構造の遵守
     - 既存ドキュメントとの整合性
     - 命名規則の一貫性維持 ( [naming_conventions.md](mdc:docs/reference/naming_conventions.md) を参照すること)
     - 共通処理の適切な配置

---

3. 品質管理と問題対応
   - 各タスクの実行結果を迅速に検証してください。
   - テスト作成時は、まず正常系に絞って実装してください
   - モックによるテストを進める場合、本番の動作に影響を与えないような記述を心がけてください
   - エラーや不整合が発生した場合は、以下のプロセスで対応してください：
     a. 問題の切り分けと原因特定（ログ分析、デバッグ情報の確認）
     b. 対策案の作成と実施
     c. 修正後の動作検証
     d. デバッグログの確認と分析
   
   - 検証結果は以下の形式で記録してください：
     a. 検証項目と期待される結果
     b. 実際の結果と差異
     c. 必要な対応策（該当する場合）

---

4. 最終確認
   - すべてのタスクが完了したら、成果物全体を評価してください。
   - 当初の指示内容との整合性を確認し、必要に応じて調整を行ってください。
   - 実装した機能に重複がないことを最終確認してください。
   - 今後のために記録すべき事項を、実装ノート [implementation.md](mdc:docs/development/implementation.md) に追記してください。

---

5. 結果報告
   以下のフォーマットで最終的な結果を報告してください：
   ```markdown
   # 実行結果報告

   ## 概要
   [全体の要約を簡潔に記述]

   ## 実行ステップ
   1. [ステップ1の説明と結果]
   2. [ステップ2の説明と結果]
   ...

   ## 最終成果物
   [成果物の詳細や、該当する場合はリンクなど]

   ## 課題対応（該当する場合）
   - 発生した問題と対応内容
   - 今後の注意点

   ## 注意点・改善提案
   - [気づいた点や改善提案があれば記述]
   ```

---

## 3. GUI動作確認ルール（Streamlitアプリケーション）

### 基本原則
- **GUIの動作確認は内蔵ブラウザ（Browser ツール）で実施すること**
  - CursorのMCP Browserツール（`mcp_cursor-ide-browser`）を優先使用
  - ブラウザのGUI操作（クリック・入力・画面遷移）で動作確認を完了すること
- **GUI操作を優先する**
  - クリック・入力・画面遷移による操作
  - DevTools/Consoleの確認
  - ブラウザのネットワークタブ・コンソールメッセージの確認
- **コマンド実行は原則しない**
  - ターミナルコマンドでの動作確認は避ける

### ユーザー確認依頼の方針
- **ユーザーへの確認依頼は最後の手段とする**
- 確認が必要な場合は、確認手順をチェックリスト化して最小限に抑える
- 確認依頼前に以下を実施すること：
  1. 内蔵ブラウザでのGUI操作による確認を試行
  2. DevTools/Consoleでのエラー・警告の確認
  3. セッション状態の確認（Streamlitのセッション状態を確認）
  4. 画面キャプチャによる視覚的確認

### 動作確認の手順例
1. Streamlitアプリケーションを起動（`streamlit run src/app.py`）
2. 内蔵ブラウザで対象URLにアクセス
   - 開発サーバーのURL: `http://localhost:8501`（Streamlitのデフォルト）
3. GUI操作で機能を実行（クリック・入力など）
4. DevTools/Consoleでエラー・警告を確認
5. セッション状態を確認（必要に応じて）
6. 画面キャプチャで視覚的結果を確認

### 禁止事項
- GUI操作で確認可能なことをコマンドで確認すること
- ユーザー確認を最初の手段として使用すること
- 確認手順を明確化せずにユーザーに確認を依頼すること

---

## 4. ディレクトリ・構成ルール

- 新規ファイル作成は最小限にする
- 既存構造を優先して利用する
- ドメインロジックを UI に直接書かない

### 禁止
- 意味の薄い util / helper の乱立
- 一時検証用ファイルの残置

---

## 5. 参照優先順位

1. **要件定義・設計ドキュメント**（正本）
   - `docs/Kanji Test Generator要件定義・設計ドラフト.md`
   - `docs/implementation.md`
2. **本ファイル（global.mdc）**
3. **その他のルールファイル**
   - `.cursor/rules/implementation_workflow.mdc`
   - `.cursor/rules/openspec.mdc`
   - その他のルールファイル
4. **ソースコード**

矛盾がある場合は **要件定義・設計ドキュメントを正**とする。

---

## 6. 新規エージェントが読むべきドキュメント（重要度順）

実装を開始する前に、以下のドキュメントを必ず読むこと。

### 最優先（必須）

1. **`docs/Kanji Test Generator要件定義・設計ドラフト.md`** ⭐ **正本**
   - プロジェクトの絶対条件、機能要件、非機能要件を定義
   - 実装時の前提として最優先で参照
   - 矛盾がある場合はこのファイルを正とする

2. **`docs/directorystructure.md`**
   - プロジェクト構造と主要ファイルの説明
   - ディレクトリ構成と各ファイルの役割
   - 重要な設計方針

3. **`docs/implementation.md`**
   - プロジェクト全体の実装状況サマリー
   - 完了した実装タスク
   - 未完了の実装タスク
   - バグ修正記録

### 実装前に読むべき（推奨）

4. **`docs/naming_conventions.md`**
   - 命名規則（変数、関数、クラス）
   - カテゴリ別命名規則
   - 使用禁止の命名パターン

5. **`.cursor/rules/implementation_workflow.mdc`**
   - 統合実装ワークフロー
   - テスト駆動開発の手順
   - ドキュメント更新ルール

### 必要に応じて参照

6. **`docs/tag_history.md`**
   - Gitタグ履歴とバージョン管理
   - 各バージョンの変更内容

7. **`AGENTS.md`**
   - OpenSpecの使用方法
   - 仕様駆動開発のワークフロー

### 参照方法

- これらのドキュメントは `@` 記号で参照可能（例：`@directorystructure.md`）
- 不明点がある場合は、まず上記のドキュメントを確認してから質問すること

---

## 重要な注意事項
- 既存のドキュメントに記載してある要件を全うすることを最優先とし、記載以外の機能強化を軽々しく実装しないでください。
- 不明点がある場合は、作業開始前に必ず確認を取ってください。
- 重要な判断が必要な場合は、その都度報告し、承認を得てください。
- 予期せぬ問題が発生した場合は、即座に報告し、対応策を提案してください。
- **明示的に指示されていない変更は行わないでください。** 必要と思われる変更がある場合は、まず提案として報告し、承認を得てから実施してください。
- **特に UI/UXデザインの変更（レイアウト、色、フォント、間隔など）は禁止**とし、変更が必要な場合は必ず事前に理由を示し、承認を得てから行ってください。
- **技術スタックに記載のバージョン（APIやフレームワーク、ライブラリ等）を勝手に変更しないでください。** 変更が必要な場合は、その理由を明確にして承認を得るまでは変更を行わないでください。

---

## 運用方針

- 最初から完璧を目指さない
- 壊れたらルールを 1 行足す
- 守れないルールは削除する
- Cursor が迷ったら Plan を詳細化する

このファイルは **初期安全装置**であり、完成形ではない。

---

以上の指示に従い、確実で質の高い実装を行います。指示された範囲内でのみ処理を行い、不要な追加実装は行いません。不明点や重要な判断が必要な場合は、必ず確認を取ります。
