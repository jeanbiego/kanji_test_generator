
### 6. ファイル命名規則

#### 6.1 実装タスクファイル
- 形式: `{YYYYMMDD}_implementation_{タスク名}.md`
- 例: `20250127_implementation_basic_functionality.md`

#### 6.2 完了後のファイル
- **ファイル名変更禁止**: 実装完了後も元のファイル名を維持
- **理由**: tag_history.mdとの整合性保持、実装履歴の追跡性確保
- **形式**: `{YYYYMMDD}_implementation_{タスク名}.md`（変更なし）

**完了状態の表示方法**:
- ファイル内の状態を「完了」に更新
- ファイル名の末尾に「（完了）」を追加するのは禁止
- 代わりにファイル内容で完了状態を明確化

### 7. 課題と実装ファイルの紐づけ管理

#### 7.1 課題記録の形式
各課題は以下の形式で記録し、対応する実装ファイルへのリンクを含める：

```markdown
**課題名**: [課題の概要]
**詳細**: [対応する実装ファイル名]
**状態**: [未着手/進行中/完了]
**優先度**: [高/中/低]
**影響度**: [高/中/低] - 全体の処理への影響範囲
**担当**: [担当者名]
```

#### 7.2 実装ファイルへのリンク形式
- **実装中**: `[ファイル名](docs/ファイル名)`
- **完了後**: `[ファイル名](docs/implementation/ファイル名)`
- **例**: `[20250127_implementation_basic_functionality.md](docs/20250127_implementation_basic_functionality.md)`

#### 7.3 課題の更新ルール
1. **新規課題追加時**: 対応する実装ファイルを作成し、リンクを設定
2. **課題完了時**: 状態を「完了」に更新し、完了日を記録
3. **実装ファイル移動時**: リンクを適切に更新

#### 7.4 実装完了時の自動更新ルール
**ユーザーが完了と認めたタスクは、実装ノートから消し、関連ノートはdocs/implementationに移す**

1. **docs/implementation.mdの更新**
   - 該当課題を実装ノートから削除
   - 完了した実装タスクセクションに移動
   - 完了日を記録
   - 次回予定を更新

2. **実装ファイルの移動**
   - 完了した実装ファイルを`docs/implementation/`に移動
   - ファイル名は変更しない（tag_history.mdとの整合性保持）
   - リンクを適切に更新

3. **実装完了サマリーの追加**
   - 完了した実装内容の詳細記録
   - 動作確認結果の記録
   - 今後の運用方針の記録

4. **状態の更新**
   - ファイル末尾の状態を「実装完了、テスト完了」に更新
   - 最終更新日を実装完了日に更新

**注意**: 実装完了後は必ず上記の更新を実行し、ドキュメントの整合性を保つ

#### 7.5 影響度の定義
- **高**: アプリケーション全体の構造、主要機能、複数モジュールに影響
- **中**: 特定の機能やモジュールに影響、他の部分への波及効果あり
- **低**: 限定的な範囲（設定、UI、特定ファイル）のみに影響

---

## 現在の実装状況

### 現在のタグ/ブランチ
- **タグ**: v1.3.0-batch-files
- **状態**: 基本機能実装完了、UI/UX改善完了、バッチファイル追加完了、モジュールインポートエラー修正中

### 実装方針

## 完了した実装タスク

### Phase 1: 基本機能実装（完了）
**目標**: アプリケーションの基本機能を実装し、動作可能な状態にする

✅ **課題1**: プロジェクト構造の構築
✅ **課題2**: データモデルの実装
✅ **課題3**: 問題入力機能の実装
✅ **課題4**: プレビュー機能の実装
✅ **課題5**: 印刷用ページ表示機能の実装

### Phase 2: データ管理機能（完了）
**目標**: 問題と試行データの永続化と管理機能を実装

✅ **課題6**: CSV入出力機能の実装
✅ **課題7**: 問題履歴管理機能の実装
✅ **課題8**: 試行ログ管理機能の実装

### 追加実装機能（完了）
✅ **重複チェック機能**: 問題作成時の重複検出と警告表示
✅ **印刷用ページのUI改善**: 印刷時の表示と操作性の向上
✅ **サイドメニューの表示形式変更**: プルダウンから常時表示形式への変更
✅ **印刷時のフォントサイズ調整**: 印刷用ページのフォントサイズを20ptsに変更
⚠️ **リセットボタンの動作改善**: フォーム内容のリセット機能の改善（部分的解決）
✅ **課題13**: 採点機能の拡張
✅ **課題14**: 履歴管理機能の拡張
✅ **課題9**: 採点UIの実装
✅ **課題10**: エラーハンドリングの強化
✅ **課題11**: 問題作成フローの改善とリセットボタンの修正
✅ **課題17**: モジュールインポートエラーの修正
✅ **課題18**: 問題用紙作成ページの自動抽出機能実装
✅ **課題19**: 採点ページの自動採点機能実装
✅ **課題20**: 不要機能ページの削除

## 未完了の実装タスク


### Phase 5: バグ修正（優先度：高）
**目標**: 既存機能の動作不良を修正し、安定性を向上させる




### 技術スタック

#### フレームワーク
- **Streamlit**: Webアプリケーションフレームワーク
- **Python 3.10+**: プログラミング言語

#### 印刷機能
- **ブラウザ印刷機能**: Chrome、Firefox、Edge等の印刷機能を使用
- **HTML/CSS**: 印刷用ページのレンダリング
- **Jinja2**: テンプレートエンジン

#### データ管理
- **CSV**: データ永続化
- **pandas**: データ処理

#### フォント
- **ブラウザデフォルトフォント**: 日本語対応フォントを自動選択

### 品質管理

#### テスト戦略
- **単体テスト**: 各モジュールの動作確認
- **統合テスト**: モジュール間の連携確認
- **システムテスト**: 全体の動作確認
- **カバレッジ目標**: 80%以上

#### コード品質
- **Ruff/Black**: コードフォーマットとリント
- **型ヒント**: 適切な型ヒントの追加
- **ドキュメント**: docstringの記述

## 実装完了サマリー

### 完了した実装タスク（2025-01-27）
**Phase 1-2の基本機能実装**: 8件完了
**Phase 3のUI/UX改善**: 4件完了、1件部分的完了
**Phase 4の高度な機能**: 2件完了
**Phase 5の追加課題**: 1件完了
**Phase 6の最終課題**: 4件完了

#### 完全解決した課題
1. **重複チェック機能の動作不良修正** ✅
   - フォーム送信処理の修正
   - フォーム内での重複警告表示
   - デバッグ出力の削除とクリーンアップ

2. **印刷用ページのUI改善** ✅
   - 印刷時のフォントサイズを20ptsに変更
   - 「印刷」「閉じる」ボタンの非表示
   - CSSのHTML埋め込みによる確実な適用

3. **サイドメニューの表示形式変更** ✅
   - プルダウンメニューからボタンベースのナビゲーションに変更
   - 常時表示のサイドバーメニュー
   - 現在のページの視覚的表示

4. **印刷時のフォントサイズ調整** ✅
   - 印刷時のフォントサイズを20ptsに変更
   - 各要素のフォントサイズ調整
   - 印刷時の視認性向上

5. **問題作成フローの改善とリセットボタンの修正** ✅
   - 問題作成フローを「問題を追加」→「すべて保存」から「問題を作成」→「問題を保存」に変更
   - レビューモードの追加（問題保存前の内容確認ステップ）
   - リセットボタンの適切な動作
   - 不要な関数（save_all_problems）の削除
   - ユーザビリティの大幅向上

#### 部分的解決した課題
6. **リセットボタンの動作改善** ⚠️
   - ✅ 重複状態のリセット機能（正常動作）
   - ❌ フォーム内容のクリア（Streamlitの制限により未解決）
   - **制限事項**: Streamlitの`st.form`内の入力フィールドは、リセットボタンを押しても自動的にクリアされない

### 実装品質
- **テストカバレッジ**: 主要機能の単体テスト実装済み
- **コード品質**: リント・フォーマット適用済み
- **ドキュメント**: 実装方針ファイル完備
- **動作確認**: 全機能の動作確認完了



### ブロッカー
**現在、実装を阻害している問題はありません**

## バグ修正記録

### 2025-01-27 モジュールインポートエラーの修正（進行中）
- **問題**: 問題検索ページ・統計ページで「No module named 'src'」エラーが発生
- **原因**: モジュールインポート文が絶対インポート（`from src.modules`）になっている
- **修正内容**:
  - モジュールインポート文を相対インポート（`from modules`）に変更
  - 履歴ページの不要な統計情報表示を削除
  - ページ表示エラーの解決
- **影響範囲**: 問題検索機能、統計機能、履歴管理機能
- **修正ファイル**: `src/app.py`、各モジュールファイル
- **状態**: 進行中

### 2025-01-27 履歴ページエラー修正
- **問題**: 履歴ページで「'list' object has no attribute 'get'」エラーが発生
- **原因**: `problem_stats`変数の初期化タイミングとエラーハンドリングの問題
- **修正内容**:
  - `problem_stats`の初期化を`try`ブロックの外に移動
  - エラー発生時でも空の辞書を維持するように修正
  - 問題一覧表示部分で`isinstance`チェックを追加
  - エラーハンドリングを強化し、詳細なログを出力
- **影響範囲**: 履歴管理機能
- **修正ファイル**: `src/app.py`
- **状態**: 完了

## 実装優先順位計画
詳細な実装計画と優先順位については、以下のファイルを参照してください：
- [20250127_implementation_priority_plan.md](docs/20250127_implementation_priority_plan.md)

---

**最終更新日**: 2025-01-27
**状態**: 全実装タスク完了、追加課題（第2弾）完了、アプリケーション完全完成、すべての課題解決完了

## 最新の修正内容
- **問題作成フローの改善**: 「問題を追加」→「すべて保存」から「問題を作成」→「問題を保存」への変更
- **レビューモードの追加**: 問題保存前の内容確認ステップを実装
- **リセットボタンの修正**: フォームの完全なクリア機能を実装
- **不要機能の削除**: 統計機能・問題検索機能を実装ノートから削除
- **モジュールインポートエラー修正**: 問題検索ページ・統計ページの「No module named 'src'」エラーを修正完了
- **履歴ページエラー修正**: 「'list' object has no attribute 'get'」エラーを解決
- **エラーハンドリング強化**: 変数の初期化タイミングと型チェックを改善
- **安定性向上**: エラー発生時のフォールバック処理を追加
- **バッチファイル追加**: Windows環境での簡単起動を実現
- **自動抽出機能実装**: 問題用紙作成ページの苦手漢字・ランダム抽出機能を実装
- **自動採点機能実装**: 採点ページの自動採点機能と分析機能を実装
- **不要機能ページ削除**: 統計ページ・問題検索ページの完全削除を実装
- **印刷用ページレイアウト改善**: A4の1枚に5問入るように調整、ヘッダー削除
- **問題登録ページ簡素化**: 保存された問題一覧セクションの削除
- **問題データ拡張**: 不正解数フィールドの追加と自動更新機能
- **問題用紙作成ページUI改善**: 印刷設定の表示タイミング修正

## 実装ファイル管理

### 完了した実装ファイル
- [20250127_implementation_duplicate_check_fix.md](docs/implementation/20250127_implementation_duplicate_check_fix.md) - 重複チェック機能の動作不良修正
- [20250127_implementation_print_ui_improvement.md](docs/implementation/20250127_implementation_print_ui_improvement.md) - 印刷用ページのUI改善
- [20250127_implementation_sidebar_improvement.md](docs/implementation/20250127_implementation_sidebar_improvement.md) - サイドメニューの表示形式変更
- [20250127_implementation_font_size_adjustment.md](docs/implementation/20250127_implementation_font_size_adjustment.md) - 印刷時のフォントサイズ調整
- [20250127_implementation_reset_button_fix.md](docs/implementation/20250127_implementation_reset_button_fix.md) - リセットボタンの動作改善（部分的解決）
- [20250127_implementation_scoring_enhancement.md](docs/implementation/20250127_implementation_scoring_enhancement.md) - 採点機能の拡張
- [20250127_implementation_history_enhancement.md](docs/implementation/20250127_implementation_history_enhancement.md) - 履歴管理機能の拡張
- [20250127_implementation_scoring_ui.md](docs/implementation/20250127_implementation_scoring_ui.md) - 採点UIの実装
- [20250127_implementation_error_handling.md](docs/implementation/20250127_implementation_error_handling.md) - エラーハンドリングの強化
- [20250127_implementation_problem_creation_flow_improvement.md](docs/implementation/20250127_implementation_problem_creation_flow_improvement.md) - 問題作成フローの改善とリセットボタンの修正
- [20250127_implementation_auto_extraction.md](docs/implementation/20250127_implementation_auto_extraction.md) - 問題用紙作成ページの自動抽出機能実装
- [20250127_implementation_auto_scoring.md](docs/implementation/20250127_implementation_auto_scoring.md) - 採点ページの自動採点機能実装
- [20250127_implementation_remove_unused_pages.md](docs/implementation/20250127_implementation_remove_unused_pages.md) - 不要機能ページの削除

### 未着手の実装ファイル
なし（すべて完了）


### 追加課題（2025年1月27日 - 第2弾）（完了）
✅ **印刷用ページのレイアウト改善**: A4の1枚に対して5問入るように調整
✅ **印刷用ページのヘッダー削除**: スペース節約のためにヘッダー削除
✅ **問題登録ページの簡素化**: 「保存された問題一覧」セクションを削除
✅ **問題データの拡張**: 各問題のデータに「不正解数」フィールドを追加
✅ **問題用紙作成ページのUI改善**: 印刷設定の表示タイミング修正

### データファイル保護機能（2025年10月19日 - 第4弾）（完了）
✅ **データファイルGit除外**: データファイルをGit管理から除外し、巻き戻り問題を解決
✅ **自動バックアップ機能**: アプリ起動時の自動バックアップと古いバックアップの自動削除
✅ **バックアップ管理**: タイムスタンプ付きバックアップ、復元機能、統計情報表示

### 起動時空白ページ問題の修正（2025年10月19日 - 第5弾）（完了）
✅ **初期化完了フラグ**: アプリ初期化の完了を管理し、ローディング表示を実装
✅ **初期化処理最適化**: セッション状態の初期化を最適化し、エラーハンドリングを強化
✅ **バックアップ処理の非同期化**: 初期レンダリング後にバックアップ処理を実行
✅ **ページ選択ボタン最適化**: st.rerun()呼び出しを最適化し、不要な再レンダリングを防止

### 追加課題（2025年9月23日 - 第3弾）
✅ **問題登録ページ**: 重複判定でエラーが出ない場合の「入力内容は正常です」表示を削除
✅ **問題登録ページ（レビュー表示）**: レビュー表示形式を「プレビュー: 〜」に変更
✅ **問題用紙作成ページ**: 「印刷対象の問題」に「不正解数」を追加
✅ **履歴管理ページ**: 表示される問題情報に「不正解数」を追加
✅ **採点ページ**: 「採点」見出しの上に出ている問題一覧を非表示
✅ **印刷用ページ**: 「答え：」横の長方形（解答欄）の縦サイズを1.5倍に拡大

### 追加修正（2025-09-23 / v1.9.3）
✅ **データクレンジング**: `problems.csv`のID重複を除去・`incorrect_count`を補完
✅ **ストレージ**: 既存IDのみ更新保存、部分削除APIで重複IDの1件削除に対応
✅ **履歴UI**: 重複IDを非表示、操作ボタンのキー一意化
✅ **メンテスクリプト**: `scripts/clean_data.py` / `scripts/dedupe_problems.py` を追加

#### 追加課題（追記: 2025-09-23）
- **印刷用ページ（縦書き対応）**: CSSで縦書き表示にする
- **印刷レイアウト（横向きデフォルト）**: A4横向きをデフォルト設定

### 実装ファイルの命名規則
- **形式**: `{YYYYMMDD}_implementation_{タスク名}.md`
- **実装中**: `docs/`直下に配置
- **完了後**: `docs/implementation/`に移動、ファイル名変更禁止（tag_history.mdとの整合性保持）
- **状態管理**: ファイル内容で完了状態を明確化

## データファイル保護機能の詳細

### 実装内容（2025-10-19）
1. **Git管理からの除外**
   - `data/`ディレクトリ内のCSVファイルをGit管理から除外
   - `src/data/`ディレクトリ内のCSVファイルも除外
   - `.gitignore`に`backups/`ディレクトリを追加

2. **自動バックアップ機能**
   - アプリ起動時に自動的にデータファイルをバックアップ
   - タイムスタンプ付きファイル名（例：`problems_20251019_103125.csv`）
   - 30日間のバックアップ保持期間設定
   - 古いバックアップの自動削除機能

3. **バックアップ管理機能**
   - `src/modules/backup.py`モジュールの実装
   - バックアップ作成、古いファイル削除、統計情報取得
   - 指定バックアップからの復元機能
   - ログ出力による動作状況の記録

### 技術仕様
- **バックアップディレクトリ**: `backups/`
- **保持期間**: 30日間（設定可能）
- **バックアップ頻度**: アプリ起動時（セッション単位）
- **ファイル形式**: 元ファイルと同じCSV形式

## 空白ページ問題の解決（2025年10月19日 - 第6弾）（完了）

### 問題の概要
- **問題**: アプリケーション起動時にブラウザ上に空白のページが表示される
- **影響**: ユーザビリティの低下、初回利用時の混乱
- **根本原因**: StreamlitサーバーのMIME type設定問題

### 診断結果
1. **MIME type問題**: JavaScriptファイルが`content-type:text/html`で配信
2. **期待されるMIME type**: `application/javascript`
3. **結果**: ブラウザがJavaScriptファイルを実行できない
4. **環境全体の問題**: `streamlit hello`でも同じ問題が発生

### 解決策の実装
1. **Streamlitの再インストール**
   - 既存のStreamlitを完全にアンインストール
   - 同じバージョン（1.50.0）を再インストール
   - MIME type設定の正常化

2. **アプリケーション初期化の最適化**
   - `st.set_page_config()`をアプリケーションの最初に移動
   - 初期化処理の最適化
   - エラーハンドリングの強化

3. **キー重複問題の解決**
   - ボタンのキーに`hash(problem.sentence)`を追加
   - 一意性の確保

### 技術仕様
- **修正対象**: `src/app.py`の初期化処理
- **Streamlit設定**: アプリケーションの最初に`st.set_page_config()`を配置
- **キー生成**: `key=f"print_{i}_{problem.id}_{hash(problem.sentence)}"`
- **MIME type**: JavaScriptファイルが正しく`application/javascript`で配信

### 動作確認結果
- **空白ページ問題**: ✅ 完全解決
- **アプリケーション**: ✅ 正常動作
- **ユーザビリティ**: ✅ 大幅改善
- **インタラクション**: ✅ 正常動作
- **エラーハンドリング**: バックアップ失敗時もアプリは継続動作

### 解決した問題
- **Git巻き戻り問題**: データファイルがGit管理から除外され、コミット巻き戻り時にデータが消失しない
- **データ保護**: 定期的な自動バックアップにより、データ損失リスクを軽減
- **運用性向上**: 手動バックアップ不要、自動化による運用負荷軽減
- **起動時空白ページ問題**: 初期化処理の最適化により、アプリ起動時の空白ページ表示を解決
- **ユーザビリティ向上**: ローディング表示とエラーハンドリングにより、ユーザー体験を改善